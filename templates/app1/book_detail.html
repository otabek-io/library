{% extends 'base.html' %}
{% load static %}
{% block content %}
    <div class="book-detail-container">
        <!-- Sahifa sarlavhasi -->
        <div class="page-header">
            <h1 class="page-title">Kitob tafsilotlari</h1>
            <div class="divider"></div>
        </div>

        <!-- Asosiy kitob ma'lumotlari -->
        <div class="book-detail-card">
            <div class="book-content">
                <!-- Kitob rasmi -->
                <div class="book-image-section">
                    <div class="book-image-container">
                        <img src="{{ book.image.url }}" alt="{{ book.name }}" class="book-image">
                        <div class="book-image-overlay">
                            <span class="book-badge">Ko'rilmoqda</span>
                        </div>
                    </div>

                    <!-- Kitob harakatlari (actions) -->
                    <div class="book-actions">
                        <form method="post">{% csrf_token %}
                            <button type="submit" name="submit_favorites" class="btn-action btn-favorite" id="add-to-favorites">
                                <i class="fas fa-heart"></i> Sevimlilar
                            </button>
                        </form>
                        <button class="btn-action btn-share" id="share-book">
                            <i class="fas fa-share-alt"></i> Ulashish
                        </button>
                        <a href="{{ book.book_file.url }}" class="btn-action btn-download" id="download-book">
                            <i class="fas fa-download"></i>Yuklab olish
                        </a>
                    </div>
                </div>

                <!-- Kitob tafsilotlari -->
                <div class="book-info-section">
                    <!-- Kitob nomi va muallifi -->
                    <div class="book-header">
                        <h1 class="book-title">{{ book.name }}</h1>
                        <div class="book-author">
                            <i class="fas fa-user-pen"></i>
                            <span class="author-name">Muallif: {{ book.author }}</span>
                        </div>

                        <!-- Reyting -->
<div class="book-rating">
    <form action="{% url 'book-detail' book.id %}" method="post">
        {% csrf_token %}
            <div class="stars-input">
                {% for i in "54321" %}
                    <input type="radio" name="stars" value="{{ i }}" id="st{{ i }}"
                           {% if user_ratings|slugify == i %}checked{% endif %}>
                    <label for="st{{ i }}"><i class="fas fa-star"></i></label>
                {% endfor %}
            </div>

        <span class="rating-text">
            {{ avg_rating|floatformat:1 }} ({{ rating_count }} ta baho)
        </span>

        <button type="submit" name="submit_rating" class="btn-rate">
            Reytingni saqlash
        </button>
    </form>
</div>
                    </div>

                    <!-- Kitob xususiyatlari -->
                    <div class="book-features">
                        <div class="feature">
                            <i class="fas fa-book-open"></i>
                            <span id="page-count">345 sahifa</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-calendar"></i>
                            <span id="publish-year">2023 nashri</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-tag"></i>
                            <span id="book-category">Fantastika</span>
                        </div>
                        <div class="feature">
                            <i class="fas fa-language"></i>
                            <span id="book-language">O'zbek tili</span>
                        </div>
                    </div>

                    <!-- Kitob tavsifi -->
                    <div class="book-description">
                        <h3><i class="fas fa-file-lines"></i> Tavsif</h3>
                        <p id="description-text">{{ book.description }}</p>
                    </div>
                </div>
            </div>
        </div>

<section class="comments-section">

    <!-- Comment Form -->
    <div class="comment-form-container">
        <div class="comment-form-header">
            <h3><i class="fas fa-comment-medical"></i> Fikringizni qoldiring</h3>
        </div>

        <form method="post" class="comment-form">
            {% csrf_token %}
            <div class="form-group">
                <div class="comment-textarea-container">
                    <textarea
                        name="comment"
                        class="comment-textarea"
                        placeholder="Kitob haqida fikringizni yozing..."
                        maxlength="1000"
                    ></textarea>
                    <div class="char-count">
                        <span id="char-counter">0</span>/1000
                    </div>
                </div>
            </div>

            <button type="submit" name="submit_comment" class="comment-submit-btn">
                <i class="fas fa-paper-plane"></i> Yuborish
            </button>
        </form>
    </div>

    <!-- Comments List -->
    <div class="comments-list">
        <div class="comments-list-header">
            <h3><i class="fas fa-comments"></i> Barcha sharhlar</h3>
            <div class="comments-sort">
                 <div class="comments-count">{{ book.comments.count }} ta sharh</div>
            </div>
        </div>

        <div class="comments-list-container">
            {% if book.comments.all %}
                {% for comment in book.comments.all %}
                <div class="comment-card">
                    <div class="comment-header">
                        <div class="comment-user">
                            <div class="user-avatar">
                                {{ comment.author.first_name|first|upper }}
                            </div>
                            <div class="user-info">
                                <h4>{{ comment.author.get_full_name }}</h4>
                                <span class="user-role">
                                    {% if comment.author.is_staff %}
                                        Admin
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        {% if user == comment.author %}
                            <div class="comment-meta">
                                <form action="{%url 'comment_delete' comment.pk %}" method="post" style="display:inline">{% csrf_token %}
                                    <button aria-label="Delete item" class="delete-button" onclick="return confirm('Rostan ham o\'chirmoqchimisiz?')">
                                      <svg
                                        class="trash-svg"
                                        viewBox="0 -10 64 74"
                                        xmlns="http://www.w3.org/2000/svg"
                                      >
                                        <g id="trash-can">
                                          <rect
                                            x="16"
                                            y="24"
                                            width="32"
                                            height="30"
                                            rx="3"
                                            ry="3"
                                            fill="#e74c3c"
                                          ></rect>

                                          <g transform-origin="12 18" id="lid-group">
                                            <rect
                                              x="12"
                                              y="12"
                                              width="40"
                                              height="6"
                                              rx="2"
                                              ry="2"
                                              fill="#c0392b"
                                            ></rect>
                                            <rect
                                              x="26"
                                              y="8"
                                              width="12"
                                              height="4"
                                              rx="2"
                                              ry="2"
                                              fill="#c0392b"
                                            ></rect>
                                          </g>
                                        </g>
                                      </svg>
                                    </button>
                                </form>
                                <span class="comment-date">{{ comment.created_at|date:'d.m.Y' }}</span>
                                <span class="comment-time">{{ comment.created_at|time:'H:i' }}</span>
                            </div>
                        {% endif %}
                    </div>

                    <div class="comment-content">
                        {{ comment.comment|linebreaks }}
                    </div>


                </div>
                {% endfor %}
            {% else %}
                <div class="empty-comments">
                    <i class="far fa-comment-slash"></i>
                    <h4>Hali sharhlar mavjud emas</h4>
                    <p>Birinchi bo'lib fikringizni bildiring</p>
                </div>
            {% endif %}
        </div>

        {% if book.comments.count > 5 %}
        <div class="load-more-container">
            <button class="load-more-btn" id="load-more-comments">
                <i class="fas fa-chevron-down"></i>
                Ko'proq sharhlar
            </button>
        </div>
        {% endif %}
    </div>
</section>
    </div>

    <script src="{% static 'app1/js/book_detail.js' %}"></script>
{% endblock content %}